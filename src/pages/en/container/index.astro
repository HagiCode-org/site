---
import Clarity from "@/components/Clarity.astro";
import '@/styles/homepage.css';
import '@/styles/container.css';
import Navbar from '@/components/home/Navbar';
import Footer from '@/components/home/Footer';
import FeatureIcon from '@/components/desktop/FeatureIcon.astro';
import FeatureTagIcon from '@/components/desktop/FeatureTagIcon.astro';
import { getLink } from '@/lib/shared/links';
import { fetchDesktopVersions, groupAssetsByPlatform } from "@/lib/shared/desktop-utils";
import { setDesktopServerData } from "@/lib/shared/version-manager";
import type { DesktopVersion, PlatformGroup } from "@/lib/shared/desktop";
import { getTranslation } from '@/i18n/ui';

// SEO 元数据
const title = "Hagicode Container - Docker Deployment";
const description = "Deploy Hagicode with Docker Compose Builder. Simple configuration, ready to use. Supports multiple image sources and automatic updates.";

// 获取当前语言环境
const currentLocale = 'en';
const { t } = getTranslation('en');

// 获取站点基础路径
const siteBase = import.meta.env.VITE_SITE_BASE || '';

// 直接构造完整的 URL 字符串，避免 new URL 的路径解析问题
const canonicalUrl = `https://hagicode.com${siteBase ? `${siteBase}en/container/` : '/en/container/'}`;
const chineseUrl = `https://hagicode.com${siteBase ? `${siteBase}container/` : '/container/'}`;
const dockerComposeDocsUrl = getLink('dockerCompose');

// 获取桌面版本信息（用于 Navbar 的 Install Button）
let desktopVersionData: {
  latest: DesktopVersion | null;
  platforms: PlatformGroup[];
  error: string | null;
  channels: {
    stable: { latest: DesktopVersion | null; all: DesktopVersion[] };
    beta: { latest: DesktopVersion | null; all: DesktopVersion[] };
  };
} = {
  latest: null,
  platforms: [],
  error: null,
  channels: {
    stable: { latest: null, all: [] },
    beta: { latest: null, all: [] }
  }
};

try {
  const data = await fetchDesktopVersions();

  // 注入数据到 VersionManager（用于客户端组件）
  setDesktopServerData(data);

  // 优先使用 channels.stable.latest 作为默认显示的版本
  if (data.channels && data.channels.stable && data.channels.stable.latest) {
    const stableLatestVersion = data.channels.stable.latest;
    desktopVersionData.latest = data.versions.find(v => v.version === stableLatestVersion) || data.versions[0] || null;
  } else {
    desktopVersionData.latest = data.versions[0] || null;
  }

  if (desktopVersionData.latest) {
    desktopVersionData.platforms = groupAssetsByPlatform(desktopVersionData.latest.files);
  }

  // 处理渠道数据（如果存在）
  if (data.channels) {
    // 从 channels 数据中提取版本信息
    const stableVersions = data.channels.stable?.versions || [];
    const betaVersions = data.channels.beta?.versions || [];
    const stableLatest = data.channels.stable?.latest;
    const betaLatest = data.channels.beta?.latest;

    // 查找对应的版本对象
    if (stableLatest) {
      desktopVersionData.channels.stable.latest = data.versions.find(v => v.version === stableLatest) || null;
    }
    if (betaLatest) {
      desktopVersionData.channels.beta.latest = data.versions.find(v => v.version === betaLatest) || null;
    }

    // 获取渠道的所有版本
    desktopVersionData.channels.stable.all = data.versions.filter(v => stableVersions.includes(v.version));
    desktopVersionData.channels.beta.all = data.versions.filter(v => betaVersions.includes(v.version));
  }
} catch (e) {
  desktopVersionData.error = e instanceof Error ? e.message : String(e);
  console.error("Failed to fetch desktop versions:", e);
}
---

<!doctype html>
<html lang={currentLocale} data-site-base={siteBase}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    <!-- SEO hreflang tags -->
    <link rel="alternate" hreflang="zh-CN" href={chineseUrl} />
    <link rel="alternate" hreflang="en" href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={chineseUrl} />
    <!-- Baidu search engine verification -->
    <meta name="baidu-site-verification" content="codeva-A9s3yT3z5m" />
    <meta name="og:title" content={title} />
    <meta name="og:description" content={description} />
    <meta name="og:type" content="website" />
    <script is:inline>
      // Initialize language for English pages to prevent incorrect locale detection
      localStorage.setItem('lang', 'en');
    </script>
    <script is:inline>
      // Initialize theme - consistent with homepage
      (function() {
        function isLunarNewYearPeriod() {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1;
          const day = now.getDate();

          if (year === 2025) {
            if (month === 1 && day >= 29) return true;
            if (month === 2 && day <= 12) return true;
          }
          if (year === 2026) {
            if (month === 2 && day >= 17) return true;
            if (month === 3 && day <= 3) return true;
          }
          return false;
        }

        const stored = localStorage.getItem('starlight-theme');
        const system = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        let theme;

        if (stored) {
          theme = stored;
        } else {
          theme = isLunarNewYearPeriod() ? 'lunar-new-year' : system;
        }

        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body class="homepage">
    <Navbar
      client:load
      desktopVersion={desktopVersionData.latest}
      desktopPlatforms={desktopVersionData.platforms}
      desktopVersionError={desktopVersionData.error}
      desktopChannels={desktopVersionData.channels}
      locale="en"
    />

    <main class="homepage">
      <!-- Hero Section -->
      <section class="hero">
        <div class="tech-grid-bg" />
        <div class="bgGlow" />
        <div class="hero-content">
          <div class="hero-badge">{t('container.hero.badge')}</div>
          <h1>{t('container.hero.title')}</h1>
          <p class="hero-tagline">{t('container.hero.tagline')}</p>

          <div class="hero-value-prop">
            <div class="value-point">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 7h-9m1 4h-8m8 4h-8m5 4h-8" stroke-linecap="round" stroke-linejoin="round"/>
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              </svg>
              <span>{t('container.hero.value1')}</span>
            </div>
            <div class="value-point">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="10"/>
              </svg>
              <span>{t('container.hero.value2')}</span>
            </div>
            <div class="value-point">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>{t('container.hero.value3')}</span>
            </div>
          </div>

          <!-- Docker Compose Builder CTA -->
          <div class="hero-cta">
            <a href={dockerComposeDocsUrl} class="btn btn-primary btn-large">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13.983 11.078h2.119a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.119a.185.185 0 00-.185.185v1.888c0 .102.083.185.185.185m-2.954-5.43h2.118a.186.186 0 00.186-.186V3.574a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.186m0 2.716h2.118a.187.187 0 00.186-.186V6.29a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.887c0 .102.082.185.185.186m-2.93 0h2.12a.186.186 0 00.184-.186V6.29a.185.185 0 00-.185-.185H8.1a.185.185 0 00-.185.185v1.887c0 .102.083.185.185.186m-2.964 0h2.119a.186.186 0 00.185-.186V6.29a.185.185 0 00-.185-.185H5.136a.186.186 0 00-.186.185v1.887c0 .102.084.185.186.186m5.893 2.715h2.118a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.185m-2.93 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.083.185.185.185m-2.964 0h2.119a.185.185 0 00.185-.185V9.006a.185.185 0 00-.185-.186h-2.12a.186.186 0 00-.185.186v1.887c0 .102.084.185.186.185m-2.92 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.082.185.185.185M23.763 9.89c-.065-.051-.672-.51-1.954-.51-.338.001-.676.03-1.01.087-.248-1.7-1.653-2.53-1.716-2.566l-.344-.199-.226.327c-.284.438-.49.922-.612 1.43-.23.97-.09 1.882.403 2.661-.595.332-1.55.413-1.744.42H.751a.751.751 0 00-.75.748 11.376 11.376 0 00.692 4.062c.545 1.428 1.355 2.48 2.41 3.124 1.18.723 3.1 1.137 5.275 1.137.983.003 1.963-.086 2.93-.266a12.248 12.248 0 003.823-1.389c.98-.567 1.86-1.288 2.61-2.136 1.252-1.418 1.998-2.997 2.553-4.4h.221c1.372 0 2.215-.549 2.68-1.009.309-.293.55-.65.707-1.046l.098-.288z"/>
              </svg>
              {t('container.hero.ctaButton')}
            </a>
          </div>

          <div class="hero-features">
            <span class="feature-tag">
              <FeatureTagIcon name="lock" />
              {t('container.hero.features.isolation')}
            </span>
            <span class="feature-tag">
              <FeatureTagIcon name="bolt" />
              {t('container.hero.features.oneClick')}
            </span>
            <span class="feature-tag">
              <FeatureTagIcon name="computer" />
              {t('container.hero.features.fastStart')}
            </span>
          </div>
        </div>
      </section>

      <!-- Features Section -->
      <section class="features">
        <h2>{t('container.features.title')}</h2>
        <div class="features-grid">
          <div class="feature-card">
            <div class="feature-icon-wrapper">
              <FeatureIcon name="lock" size={48} />
            </div>
            <h3>{t('container.features.isolation.title')}</h3>
            <p>{t('container.features.isolation.description')}</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon-wrapper">
              <FeatureIcon name="rocket" size={48} />
            </div>
            <h3>{t('container.features.simple.title')}</h3>
            <p>{t('container.features.simple.description')}</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon-wrapper">
              <FeatureIcon name="computer" size={48} />
            </div>
            <h3>{t('container.features.crossPlatform.title')}</h3>
            <p>{t('container.features.crossPlatform.description')}</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon-wrapper">
              <FeatureIcon name="globe" size={48} />
            </div>
            <h3>{t('container.features.persistent.title')}</h3>
            <p>{t('container.features.persistent.description')}</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon-wrapper">
              <FeatureIcon name="arrow-path" size={48} />
            </div>
            <h3>{t('container.features.autoUpdate.title')}</h3>
            <p>{t('container.features.autoUpdate.description')}</p>
          </div>
          <div class="feature-card">
            <div class="feature-icon-wrapper">
              <FeatureIcon name="bolt" size={48} />
            </div>
            <h3>{t('container.features.productionReady.title')}</h3>
            <p>{t('container.features.productionReady.description')}</p>
          </div>
        </div>
      </section>

      <!-- Docker Compose Builder Intro Section -->
      <section class="builder-intro">
        <h2>{t('container.builder.title')}</h2>
        <p class="section-description">{t('container.builder.subtitle')}</p>

        <div class="builder-content">
          <div class="builder-feature">
            <div class="builder-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="12" cy="12" r="10"/>
              </svg>
            </div>
            <h3>{t('container.builder.visual.title')}</h3>
            <p>{t('container.builder.visual.description')}</p>
          </div>

          <div class="builder-feature">
            <div class="builder-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h3>{t('container.builder.generate.title')}</h3>
            <p>{t('container.builder.generate.description')}</p>
          </div>

          <div class="builder-feature">
            <div class="builder-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 15V3m0 12l-4-4m4 4l4-4M2 17l.621 2.485A2 2 0 004.561 21h14.878a2 2 0 001.94-1.515L22 17" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h3>{t('container.builder.deploy.title')}</h3>
            <p>{t('container.builder.deploy.description')}</p>
          </div>

          <div class="builder-feature">
            <div class="builder-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h3>{t('container.builder.secure.title')}</h3>
            <p>{t('container.builder.secure.description')}</p>
          </div>
        </div>

        <div class="builder-cta">
          <a href={dockerComposeDocsUrl} class="btn btn-primary btn-large">
            {t('container.builder.ctaButton')}
            <svg class="btn-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      </section>

      <!-- Mirror Sources Section -->
      <section class="mirror-sources">
        <h2>{t('container.mirrors.title')}</h2>
        <p class="section-description">{t('container.mirrors.description')}</p>

        <div class="mirror-grid">
          <div class="mirror-card">
            <div class="mirror-header">
              <svg class="mirror-logo" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13.983 11.078h2.119a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.119a.185.185 0 00-.185.185v1.888c0 .102.083.185.185.185m-2.954-5.43h2.118a.186.186 0 00.186-.186V3.574a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.186m0 2.716h2.118a.187.187 0 00.186-.186V6.29a.186.186 0 00-.186-.185h-2.118a.185.185 0 00-.185.185v1.887c0 .102.082.185.185.186m-2.93 0h2.12a.186.186 0 00.184-.186V6.29a.185.185 0 00-.185-.185H8.1a.185.185 0 00-.185.185v1.887c0 .102.083.185.185.186m-2.964 0h2.119a.186.186 0 00.185-.186V6.29a.185.185 0 00-.185-.185H5.136a.186.186 0 00-.186.185v1.887c0 .102.084.185.186.186m5.893 2.715h2.118a.186.186 0 00.186-.185V9.006a.186.186 0 00-.186-.186h-2.118a.185.185 0 00-.185.185v1.888c0 .102.082.185.185.185m-2.93 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.083.185.185.185m-2.964 0h2.119a.185.185 0 00.185-.185V9.006a.185.185 0 00-.185-.186h-2.12a.186.186 0 00-.185.186v1.887c0 .102.084.185.186.185m-2.92 0h2.12a.185.185 0 00.184-.185V9.006a.185.185 0 00-.184-.186h-2.12a.185.185 0 00-.184.185v1.888c0 .102.082.185.185.185M23.763 9.89c-.065-.051-.672-.51-1.954-.51-.338.001-.676.03-1.01.087-.248-1.7-1.653-2.53-1.716-2.566l-.344-.199-.226.327c-.284.438-.49.922-.612 1.43-.23.97-.09 1.882.403 2.661-.595.332-1.55.413-1.744.42H.751a.751.751 0 00-.75.748 11.376 11.376 0 00.692 4.062c.545 1.428 1.355 2.48 2.41 3.124 1.18.723 3.1 1.137 5.275 1.137.983.003 1.963-.086 2.93-.266a12.248 12.248 0 003.823-1.389c.98-.567 1.86-1.288 2.61-2.136 1.252-1.418 1.998-2.997 2.553-4.4h.221c1.372 0 2.215-.549 2.68-1.009.309-.293.55-.65.707-1.046l.098-.288z"/>
              </svg>
              <h3>{t('container.mirrors.dockerHub')}</h3>
            </div>
            <p>{t('container.mirrors.dockerHubDesc')}</p>
            <div class="mirror-command">
              <code>{t('container.mirrors.dockerHubCmd')}</code>
            </div>
          </div>

          <div class="mirror-card">
            <div class="mirror-header">
              <svg class="mirror-logo" viewBox="0 0 24 24" fill="currentColor">
                <path d="M4.5 9.75V9A3.75 3.75 0 018.25 5.25h7.5A3.75 3.75 0 0119.5 9v.75m-15 0h15m-15 0A2.25 2.25 0 003.75 12v6.75A2.25 2.25 0 006 20.25h12a2.25 2.25 0 002.25-2.25V12A2.25 2.25 0 0018 9.75H6A2.25 2.25 0 003.75 9.75z"/>
              </svg>
              <h3>{t('container.mirrors.azure')}</h3>
            </div>
            <p>{t('container.mirrors.azureDesc')}</p>
            <div class="mirror-command">
              <code>{t('container.mirrors.azureCmd')}</code>
            </div>
          </div>

          <div class="mirror-card">
            <div class="mirror-header">
              <svg class="mirror-logo" viewBox="0 0 24 24" fill="currentColor">
                <path d="M4.5 9.75V9A3.75 3.75 0 018.25 5.25h7.5A3.75 3.75 0 0119.5 9v.75m-15 0h15m-15 0A2.25 2.25 0 003.75 12v6.75A2.25 2.25 0 006 20.25h12a2.25 2.25 0 002.25-2.25V12A2.25 2.25 0 0018 9.75H6A2.25 2.25 0 003.75 9.75z"/>
              </svg>
              <h3>{t('container.mirrors.aliyun')}</h3>
            </div>
            <p>{t('container.mirrors.aliyunDesc')}</p>
            <div class="mirror-command">
              <code>{t('container.mirrors.aliyunCmd')}</code>
            </div>
          </div>
        </div>
      </section>

      <!-- FAQ Section -->
      <section class="faq">
        <h2>{t('container.faq.title')}</h2>
        <div class="faq-list">
          <details class="faq-item">
            <summary>{t('container.faq.q1.question')}</summary>
            <div class="faq-content">
              <p set:html={t('container.faq.q1.intro')}></p>
              <h4>{t('container.faq.q1.desktopTitle')}</h4>
              <ul>
                <li>{t('container.faq.q1.desktop1')}</li>
                <li>{t('container.faq.q1.desktop2')}</li>
                <li>{t('container.faq.q1.desktop3')}</li>
                <li>{t('container.faq.q1.desktop4')}</li>
              </ul>
              <h4>{t('container.faq.q1.containerTitle')}</h4>
              <ul>
                <li>{t('container.faq.q1.container1')}</li>
                <li>{t('container.faq.q1.container2')}</li>
                <li>{t('container.faq.q1.container3')}</li>
                <li>{t('container.faq.q1.container4')}</li>
              </ul>
            </div>
          </details>

          <details class="faq-item">
            <summary>{t('container.faq.q2.question')}</summary>
            <div class="faq-content">
              <p set:html={t('container.faq.q2.intro')}></p>
              <ul>
                <li>{t('container.faq.q2.point1')}</li>
                <li>{t('container.faq.q2.point2')}</li>
                <li>{t('container.faq.q2.point3')}</li>
                <li>{t('container.faq.q2.point4')}</li>
              </ul>
              <p set:html={t('container.faq.q2.note')}></p>
            </div>
          </details>

          <details class="faq-item">
            <summary>{t('container.faq.q3.question')}</summary>
            <div class="faq-content">
              <p set:html={t('container.faq.q3.answer')}></p>
              <p set:html={t('container.faq.q3.note')}></p>
            </div>
          </details>

          <details class="faq-item">
            <summary>{t('container.faq.q4.question')}</summary>
            <div class="faq-content">
              <p set:html={t('container.faq.q4.intro')}></p>
              <pre><code>{t('container.faq.q4.code')}</code></pre>
              <p set:html={t('container.faq.q4.watchtower')}></p>
            </div>
          </details>

          <details class="faq-item">
            <summary>{t('container.faq.q5.question')}</summary>
            <div class="faq-content">
              <p set:html={t('container.faq.q5.intro')}></p>
              <ul>
                <li>{t('container.faq.q5.point1')}</li>
                <li>{t('container.faq.q5.point2')}</li>
                <li>{t('container.faq.q5.point3')}</li>
              </ul>
            </div>
          </details>

          <details class="faq-item">
            <summary>{t('container.faq.q6.question')}</summary>
            <div class="faq-content">
              <p set:html={t('container.faq.q6.intro')}></p>
              <ol>
                <li>
                  <strong>{t('container.faq.q6.step1.title')}</strong>
                  <pre><code>{t('container.faq.q6.step1.code')}</code></pre>
                </li>
                <li>
                  <strong>{t('container.faq.q6.step2.title')}</strong>
                  <pre><code>{t('container.faq.q6.step2.code')}</code></pre>
                </li>
                <li>
                  <strong>{t('container.faq.q6.step3.title')}</strong>
                  <p set:html={t('container.faq.q6.step3.desc')}></p>
                  <pre><code>{t('container.faq.q6.step3.code')}</code></pre>
                  <p set:html={t('container.faq.q6.step3.solution')}></p>
                  <ul>
                    <li>{t('container.faq.q6.step3.solution1')}</li>
                    <li>{t('container.faq.q6.step3.solution2')}</li>
                  </ul>
                </li>
              </ol>
              <p set:html={t('container.faq.q6.help')}></p>
            </div>
          </details>
        </div>
      </section>

      <!-- CTA Section -->
      <section class="cta-section">
        <h2>{t('container.cta.title')}</h2>
        <p>{t('container.cta.subtitle')}</p>
        <div class="cta-buttons">
          <a href={dockerComposeDocsUrl} class="btn btn-primary">
            {t('container.cta.button')}
          </a>
          <a href="https://github.com/HagiCode-org/site" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
            {t('container.cta.github')}
          </a>
        </div>
      </section>
    </main>

    <Footer locale="en" client:load />

    <!-- Microsoft Clarity analytics -->
    <Clarity />
  </body>
</html>
