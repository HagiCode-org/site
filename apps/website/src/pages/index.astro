---
/**
 * Hagicode 首页
 * 集成所有首页组件,展示产品特性和功能
 */
import Navbar from '../components/home/Navbar';
import HeroSection from '../components/home/HeroSection';
import SocialProofSection from '../components/home/SocialProofSection';
import ActivityMetricsSection from '../components/home/ActivityMetricsSection';
import FeaturesShowcase from '../components/home/FeaturesShowcase';
import ShowcaseSection from '../components/home/ShowcaseSection';
import VideoShowcase from '../components/home/VideoShowcase';
import InstallOptionsSection from '../components/home/InstallOptionsSection';
import Footer from '../components/home/Footer';
import LunarNewYearDecorations from '../components/home/LunarNewYearDecorations';
import { LunarNewYearCardGroup } from '../components/home/LunarNewYearCard';
import Clarity from '../components/Clarity.astro';
// import BaiduAnalytics from '../components/BaiduAnalytics.astro'; // Disabled, migrated to 51LA
import Analytics51LA from '../components/51LAAnalytics.astro';
// 导入首页样式
import '../styles/homepage.css';

// 导入版本数据工具函数
import { fetchDesktopVersions, groupAssetsByPlatform } from "@shared/desktop-utils";
import { setDesktopServerData } from "@shared/version-manager";
import type { DesktopVersion, PlatformGroup } from "@shared/desktop";

// 页面元数据
const title = 'Hagicode - 智能 · 便捷 · 有趣的 AI 编码助手';
const description = '用 AI 重新定义代码开发体验。OpenSpec 工作流、多线程会话管理、成就系统,让编码更高效、更有趣';

// 获取站点基础路径
const siteBase = import.meta.env.VITE_SITE_BASE || '/';

// 在构建时获取版本数据（用于 InstallButton）
let desktopVersionData: {
  latest: DesktopVersion | null;
  platforms: PlatformGroup[];
  error: string | null;
  channels: {
    stable: { latest: DesktopVersion | null; all: DesktopVersion[] };
    beta: { latest: DesktopVersion | null; all: DesktopVersion[] };
  };
} = {
  latest: null,
  platforms: [],
  error: null,
  channels: {
    stable: { latest: null, all: [] },
    beta: { latest: null, all: [] }
  }
};

try {
  const data = await fetchDesktopVersions();

  // 注入数据到 VersionManager（用于客户端组件）
  setDesktopServerData(data);

  // 优先使用 channels.stable.latest 作为默认显示的版本
  if (data.channels && data.channels.stable && data.channels.stable.latest) {
    const stableLatestVersion = data.channels.stable.latest;
    desktopVersionData.latest = data.versions.find(v => v.version === stableLatestVersion) || data.versions[0] || null;
  } else {
    desktopVersionData.latest = data.versions[0] || null;
  }

  if (desktopVersionData.latest) {
    desktopVersionData.platforms = groupAssetsByPlatform(desktopVersionData.latest.files);
  }

  // 处理渠道数据（如果存在）
  if (data.channels) {
    // 从 channels 数据中提取版本信息
    const stableVersions = data.channels.stable?.versions || [];
    const betaVersions = data.channels.beta?.versions || [];
    const stableLatest = data.channels.stable?.latest;
    const betaLatest = data.channels.beta?.latest;

    // 查找对应的版本对象
    if (stableLatest) {
      desktopVersionData.channels.stable.latest = data.versions.find(v => v.version === stableLatest) || null;
    }
    if (betaLatest) {
      desktopVersionData.channels.beta.latest = data.versions.find(v => v.version === betaLatest) || null;
    }

    // 获取渠道的所有版本
    desktopVersionData.channels.stable.all = data.versions.filter(v => stableVersions.includes(v.version));
    desktopVersionData.channels.beta.all = data.versions.filter(v => betaVersions.includes(v.version));
  }
} catch (e) {
  desktopVersionData.error = e instanceof Error ? e.message : String(e);
  console.error("Failed to fetch desktop versions for homepage:", e);
}
---

<!doctype html>
<html lang="zh-CN" data-site-base={siteBase}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <!-- 百度搜索引擎验证 -->
    <meta name="baidu-site-verification" content="codeva-A9s3yT3z5m" />
    <meta name="og:title" content={title} />
    <meta name="og:description" content={description} />
    <meta name="og:type" content="website" />
    <script is:inline>
      // 禁用浏览器的自动滚动恢复，并强制滚动到顶部
      // 防止刷新页面后跳到之前的滚动位置
      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }
      // 立即滚动到顶部
      window.scrollTo(0, 0);

      // 初始化主题 - 在页面加载前执行，避免闪烁
      // 与 Starlight 文档站同步使用 starlight-theme 键
      (function() {
        // 判断是否在农历新年期间
        // 蛇年2025: 2025-01-29 至 2025-02-12 (元宵节)
        // 马年2026: 2026-02-17 至 2026-03-03 (元宵节)
        function isLunarNewYearPeriod() {
          const now = new Date();
          const year = now.getFullYear();
          const month = now.getMonth() + 1; // 1-12
          const day = now.getDate();

          // 2025年蛇年新年期间 (1月29日 - 2月12日)
          if (year === 2025) {
            if (month === 1 && day >= 29) return true;
            if (month === 2 && day <= 12) return true;
          }
          // 2026年马年新年期间 (2月17日 - 3月3日)
          if (year === 2026) {
            if (month === 2 && day >= 17) return true;
            if (month === 3 && day <= 3) return true;
          }
          return false;
        }

        const stored = localStorage.getItem('starlight-theme');
        const system = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        let theme;

        if (stored) {
          // 用户已有主题偏好,使用其选择
          theme = stored;
        } else {
          // 用户无主题偏好,应用智能默认
          theme = isLunarNewYearPeriod() ? 'lunar-new-year' : system;
        }

        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body class="homepage">
    <!-- 新年主题装饰 - 仅在农历新年主题下显示 -->
    <LunarNewYearDecorations client:load />

    <Navbar
      client:load
      desktopVersion={desktopVersionData.latest}
      desktopPlatforms={desktopVersionData.platforms}
      desktopVersionError={desktopVersionData.error}
      desktopChannels={desktopVersionData.channels}
    />

    <main class="homepage">
      <!-- Hero Section - 首屏必需 -->
      <HeroSection
        desktopVersion={desktopVersionData.latest}
        desktopPlatforms={desktopVersionData.platforms}
        desktopVersionError={desktopVersionData.error}
        desktopChannels={desktopVersionData.channels}
        client:load
      />

      <!-- 新年主题卡片组 - 仅在农历新年主题下显示 -->
      <LunarNewYearCardGroup client:load />

      <!-- Social Proof Section - 社交证明 -->
      <SocialProofSection client:load />

      <!-- Activity Metrics Section -->
      <ActivityMetricsSection client:load />

      <!-- Features Showcase -->
      <FeaturesShowcase client:load />

      <!-- Showcase Section -->
      <ShowcaseSection client:load />

      <!-- Video Showcase -->
      <VideoShowcase
        videoId="BV1pirZBuEzq"
        title="每天哈基半小时,AI多任务编程实战"
        description="通过视频快速了解 Hagicode 的核心功能和使用方法"
        client:load
      />

      <!-- Install Options Section -->
      <InstallOptionsSection client:load />
    </main>

    <!-- Footer -->
    <Footer client:load />

    <!-- Microsoft Clarity 分析 -->
    <Clarity />

    <!-- 51LA Analytics 分析 -->
    <Analytics51LA />

    <!-- Baidu Analytics 分析 (Disabled, migrated to 51LA) -->
    <!-- <BaiduAnalytics /> -->
  </body>
</html>
