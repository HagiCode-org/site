# 提案：调整开发服务器端口配置

## 概述

将 monorepo 项目的开发服务器端口从当前配置（docs: 4321, website: 4322）调整为新的端口号（docs: 31265, website: 31264），并通过环境变量提供可配置的端口管理，以避免端口占用冲突并提供更合理的端口分配。

## 问题陈述

### 当前问题

1. **端口冲突风险**：当前使用的端口 4321 和 4322 属于低位端口范围，容易与其他开发工具或服务产生冲突
2. **缺乏端口隔离**：端口号过于接近，可能在大规模开发环境中造成管理混乱
3. **硬编码引用**：端口配置散布在多个文件中，缺乏统一的配置管理
4. **缺乏灵活性**：无法根据不同开发环境或开发者需求快速调整端口配置

### 受影响的组件

- `apps/docs` - Starlight 文档站点（当前：4321）
- `apps/website` - 营销落地页站点（当前：4322）
- `packages/shared/src/links.ts` - 包含所有硬编码的本地开发链接
- `openspec/project.md` - 项目文档中的开发说明

## 解决方案

### 新端口配置（默认值）

| 应用 | 当前端口 | 新端口（默认） | 环境变量 | 变更 |
|------|----------|----------------|----------|------|
| docs | 4321 | 31265 | `PORT_DOCS` | +26844 |
| website | 4322 | 31264 | `PORT_WEBSITE` | +26842 |

**说明**：
- 新端口通过环境变量配置，提供默认值
- 开发者可通过设置环境变量覆盖默认端口
- 未设置环境变量时使用默认端口

### 修改范围

#### 1. 环境变量配置

**`.env` 或 `.env.local`（新建）**
- 添加 `PORT_DOCS=31265` 环境变量
- 添加 `PORT_WEBSITE=31264` 环境变量
- 提供 `.env.example` 模板文件

#### 2. 应用配置文件

**`apps/docs/package.json`**
- 修改 `dev` 脚本，使用环境变量 `PORT_DOCS`，默认值 31265
- 修改 `preview` 脚本，使用环境变量 `PORT_DOCS`，默认值 31265

**`apps/website/package.json`**
- 修改 `dev` 脚本，使用环境变量 `PORT_WEBSITE`，默认值 31264
- 修改 `preview` 脚本，使用环境变量 `PORT_WEBSITE`，默认值 31264

#### 3. 共享链接配置

**`packages/shared/src/links.ts`**
- 更新 `SITE_LINKS` 对象中所有 `dev` 属性的端口号为新的默认值
- 影响的链接：
  - `docs.dev` (4321 → 31265)
  - `website.dev` (4322 → 31264)
  - `blog.dev` (4321 → 31265)
  - `productOverview.dev` (4321 → 31265)
  - `desktop.dev` (4322 → 31264)
  - `dockerCompose.dev` (4321 → 31265)
  - `container.dev` (4322 → 31264)
  - `rss.dev` (4321 → 31265)
- 添加说明注释，指出端口可通过环境变量覆盖

#### 4. 项目文档

**`openspec/project.md`**
- 更新开发脚本注释中的端口说明
- 添加环境变量配置说明
- 确保文档与实际配置保持一致

## 实施计划

### 阶段 1：准备
1. 确认新端口号未被占用
2. 创建功能分支

### 阶段 2：环境变量配置
1. 创建/更新 `.env.example` 模板文件
2. 添加端口环境变量定义（`PORT_DOCS`, `PORT_WEBSITE`）
3. 设置默认值（31265, 31264）

### 阶段 3：应用配置更新
1. 修改 `apps/docs/package.json` 使用环境变量
2. 修改 `apps/website/package.json` 使用环境变量
3. 更新 `packages/shared/src/links.ts` 端口默认值

### 阶段 4：文档同步
1. 更新 `openspec/project.md`
2. 添加环境变量使用说明

### 阶段 5：验证
1. 清理缓存和构建产物
2. 测试默认端口配置
3. 测试环境变量覆盖功能
4. 验证所有本地链接
5. 验证 preview 模式

## 影响评估

### 开发体验影响

| 影响类型 | 描述 | 缓解措施 |
|----------|------|----------|
| 工作流变更 | 团队成员需要使用新端口访问本地服务 | 更新文档，提供迁移指南 |
| 环境变量配置 | 需要了解如何设置和覆盖端口 | 提供清晰的环境变量文档和示例 |
| 脚本记忆 | 开发者可能记住旧端口号 | 通过 IDE 提示和文档更新 |
| 调试配置 | 浏览器书签、调试配置可能需要更新 | 提供清晰的迁移说明 |
| 配置灵活性 | 支持自定义端口，解决特殊场景冲突 | 提供 `.env.local` 配置示例 |

### 技术风险

| 风险 | 可能性 | 影响 | 缓解措施 |
|------|--------|------|----------|
| 新端口被占用 | 低 | 中 | 实施前验证端口可用性，支持环境变量覆盖 |
| 链接遗漏更新 | 中 | 高 | 使用全局搜索验证所有引用 |
| 缓存问题 | 中 | 低 | 清理构建产物和缓存 |
| 环境变量未设置 | 低 | 低 | 提供默认值，无需强制配置 |
| 环境变量不一致 | 低 | 中 | 提供模板文件，统一配置规范 |

### 不受影响的内容

- ✅ 生产环境部署（不涉及生产配置）
- ✅ CI/CD 流程（仅影响本地开发）
- ✅ 生产 URL（所有 `prod` 属性保持不变）
- ✅ 不设置环境变量的开发者（使用默认端口即可）

## 成功标准

### 功能验收标准

1. **开发服务器正常启动**
   - `npm run dev` 同时启动两个站点
   - docs 站点监听默认端口 31265
   - website 站点监听默认端口 31264

2. **环境变量支持**
   - 支持通过 `PORT_DOCS` 环境变量自定义 docs 端口
   - 支持通过 `PORT_WEBSITE` 环境变量自定义 website 端口
   - 未设置环境变量时使用默认值

3. **链接完整性**
   - 所有本地开发链接正确指向新的默认端口
   - 导航和跨站点链接正常工作
   - 更改端口后链接仍可通过环境变量配置保持一致

4. **文档准确性**
   - `openspec/project.md` 中的说明与实际配置一致
   - 环境变量使用说明清晰完整

### 验证步骤

```bash
# 1. 验证端口未被占用
lsof -i :31264 -i :31265

# 2. 清理并启动（使用默认端口）
npm run clean
npm run dev

# 3. 验证服务可访问
curl http://localhost:31265/  # docs (默认)
curl http://localhost:31264/  # website (默认)

# 4. 测试环境变量覆盖
PORT_DOCS=4000 PORT_WEBSITE=4001 npm run dev
curl http://localhost:4000/   # docs (自定义)
curl http://localhost:4001/   # website (自定义)

# 5. 测试 preview 模式
npm run build
npm run preview
```

## 时间表

| 阶段 | 预计时间 |
|------|----------|
| 准备和验证 | 立即执行 |
| 配置更新 | 立即执行 |
| 文档更新 | 立即执行 |
| 验证测试 | 立即执行 |

**总预计时间：** 单次开发会话可完成

## 替代方案

### 方案 A：仅使用硬编码端口（原方案）
**优点**：配置简单直接，无需额外文档
**缺点**：缺乏灵活性，无法应对个性化需求
**决策**：未采用 - 采用环境变量方案以提供更好的可配置性

### 方案 B：仅更改冲突的端口
**优点**：变更范围最小
**缺点**：仍保留低位端口，未来可能再次冲突
**决策**：未采用 - 统一调整到高位端口更彻底

## 参考资料

- Astro 端口配置文档：https://docs.astro.build/en/reference/cli-reference/#astro-dev
- Turbo monorepo 开发服务器管理
- 现有端口配置分析（见探索结果）

## 变更历史

| 日期 | 版本 | 变更说明 |
|------|------|----------|
| 2025-02-15 | 1.0 | 初始提案创建 |
| 2025-02-15 | 1.1 | 根据反馈更新：添加环境变量支持，提供端口可配置性 |

## 反馈处理

| 反馈内容 | 处理方式 | 说明 |
|----------|----------|------|
| 使用环境变量配置端口 | 已采纳 | 添加 `PORT_DOCS` 和 `PORT_WEBSITE` 环境变量，提供默认值 31265 和 31264 |

