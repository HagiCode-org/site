# 农历新年主题与智能默认机制提案

## 概述

为 Hagicode 文档站点新增农历新年专属主题,并实现基于时间窗口的智能主题默认机制,让新用户在节日期间自动获得适合的主题体验,同时尊重已有主题偏好的用户选择。

## 背景

当前 Hagicode 文档站点基于 Astro 5.x 构建,已实现完整的主题切换系统,支持亮色和暗色两种主题。主题系统具有以下特点:

- 完善的主题切换功能(ThemeToggle.tsx 组件)
- 主题状态持久化(localStorage 使用 `starlight-theme` 键名)
- 与 Starlight 文档站主题同步兼容
- 基于 CSS Custom Properties 的样式系统
- 平滑的主题切换过渡动画

然而,现有系统缺乏以下功能:

1. **缺少农历新年主题** - 没有专门为农历新年设计的视觉主题
2. **无时间感知主题激活** - 没有根据特定日期自动激活节日主题的机制
3. **无默认主题智能分配** - 对于首次访问用户,无法根据时间段自动设置合适的默认主题

## 目标

### 主要目标

1. 新增 `lunar-new-year` 农历新年主题选项,提供符合节日氛围的视觉体验
2. 实现智能默认主题机制,在农历新年期间(2月1日-3月1日)为新用户自动应用农历新年主题
3. 尊重已有主题偏好的用户,不自动覆盖其选择
4. 保持与现有主题系统的完全兼容性

### 成功标准

- [ ] 用户可以在主题切换器中手动选择农历新年主题
- [ ] 农历新年期间新用户首次访问时自动应用该主题
- [ ] 已有主题偏好的用户不受智能默认机制影响
- [ ] 主题切换、持久化和跨页面同步功能正常工作
- [ ] 通过 `npm run build` 构建验证
- [ ] TypeScript 严格模式下无类型错误
- [ ] 页面加载时无主题闪烁(FOUC)

## 影响分析

### 用户体验提升

**正面影响**:
- **节日氛围**: 在农历新年期间为用户提供节日视觉体验,增强品牌亲和力
- **智能默认**: 新用户在节日期间自动获得适合的主题,无需手动选择
- **无打扰**: 有明确主题偏好的老用户不受影响
- **视觉多样性**: 增加主题选项,满足用户个性化需求

**潜在风险**:
- 如果农历新年主题设计过于花哨,可能影响文档阅读体验
- 智能默认机制可能让部分用户困惑(为何主题自动变化)

**缓解措施**:
- 采用适度的新年装饰,保持文档可读性为首要原则
- 在主题切换器中提供清晰的主题名称和说明
- 保留用户手动选择其他主题的权利

### 技术实现范围

**新增内容**:
1. 农历新年主题 CSS 变量定义 (`src/styles/global.css`)
2. 智能默认主题逻辑 (`src/pages/index.astro` 初始化脚本)
3. 首页组件农历新年主题样式适配

**修改内容**:
1. 主题切换器组件 (`src/components/home/ThemeToggle.tsx`)
2. 主题初始化脚本 (`src/pages/index.astro`)

**无破坏性更改**:
- 现有 `light` 和 `dark` 主题功能保持不变
- 主题切换和持久化机制保持不变
- 与 Starlight 文档站的兼容性保持不变

### 兼容性要求

**必须满足**:
- ✅ 通过 `npm run build` 构建验证
- ✅ TypeScript 严格模式下无类型错误 (`npm run typecheck`)
- ✅ 符合项目现有主题系统架构
- ✅ 保持与其他主题的切换兼容性
- ✅ 与 Starlight 文档站主题系统兼容

**性能要求**:
- 新增代码 gzip 压缩后 < 3 KB
- 主题切换延迟 < 100ms
- 页面加载性能不受影响

## 实施计划

### 第一阶段:农历新年主题样式
1. 在 `src/styles/global.css` 中添加农历新年主题 CSS 变量
2. 设计红色为主色调的配色方案
3. 为首页组件添加农历新年主题适配样式

### 第二阶段:主题切换器集成
1. 扩展 ThemeToggle 组件支持农历新年主题选项
2. 更新类型定义支持 `lunar-new-year` 主题类型
3. 确保主题切换和持久化功能正常工作

### 第三阶段:智能默认机制
1. 在 `src/pages/index.astro` 中实现日期判断逻辑
2. 检查用户是否已有主题偏好设置
3. 在农历新年期间为无偏好的新用户设置默认主题为农历新年主题

### 第四阶段:测试验证
1. 功能测试(主题切换、持久化、智能默认)
2. 构建验证(`npm run build`)
3. 类型检查(`npm run typecheck`)
4. 浏览器兼容性测试

## 替代方案

### 方案 A:仅新增农历新年主题(无智能默认)

**优点**:
- 实现更简单
- 用户完全自主控制

**缺点**:
- 新用户可能不知道有农历新年主题
- 节日氛围传播受限

**结论**: 不推荐,未充分利用智能默认的优势

### 方案 B:农历新年主题强制覆盖(无论用户偏好)

**优点**:
- 确保所有用户都看到节日主题

**缺点**:
- 严重破坏用户体验
- 违背尊重用户选择的原则
- 可能引发用户反感

**结论**: 不推荐,不符合用户体验最佳实践

### 方案 C:当前方案(智能默认 + 尊重偏好)

**优点**:
- 平衡节日氛围和用户体验
- 新用户自动获得适合的主题
- 老用户不受打扰

**缺点**:
- 实现略复杂

**结论**: ✅ 推荐,最佳平衡方案

## 风险与缓解

### 风险 1:农历新年主题设计不当

**描述**: 主题设计过于花哨,影响文档可读性

**概率**: 中等

**影响**: 高

**缓解措施**:
- 采用适度的新年装饰,保持文档可读性为首要原则
- 进行用户测试收集反馈
- 设计时参考现有暗色主题的可读性标准

### 风险 2:智能默认机制逻辑错误

**描述**: 日期判断或用户偏好检测逻辑出错

**概率**: 低

**影响**: 中等

**缓解措施**:
- 充分测试日期边界条件(1月31日、2月1日、3月1日、3月2日)
- 测试 localStorage 存在/不存在各种场景
- 使用 TypeScript 类型检查确保逻辑正确

### 风险 3:构建失败或类型错误

**描述**: 代码变更导致构建失败或 TypeScript 类型错误

**概率**: 低

**影响**: 高

**缓解措施**:
- 在提交前运行 `npm run build` 和 `npm run typecheck`
- 使用 TypeScript 严格模式确保类型安全
- 遵循项目现有代码规范

### 风险 4:浏览器兼容性问题

**描述**: 新增功能在某些浏览器中不工作

**概率**: 低

**影响**: 中等

**缓解措施**:
- 测试主流浏览器(Chrome、Firefox、Safari、Edge)
- 提供降级方案,确保基础功能可用
- 遵循项目现有主题系统的兼容性标准

## 时间估算

- **第一阶段(农历新年主题样式)**: 基础实现
- **第二阶段(主题切换器集成)**: 基础实现
- **第三阶段(智能默认机制)**: 基础实现
- **第四阶段(测试验证)**: 基础实现

## 相关资源

### 相关文件
- `src/styles/global.css` - 全局主题 CSS 变量
- `src/components/home/ThemeToggle.tsx` - 主题切换器组件
- `src/pages/index.astro` - 首页(包含主题初始化脚本)
- `src/components/home/ShowcaseSection.tsx` - 产品展示组件
- `src/components/home/ActivityMetricsSection.tsx` - 活动指标组件

### 相关规范
- `openspec/specs/theme-system/spec.md` - 主题系统规范

### 参考资源
- Astro 主题切换最佳实践: https://docs.astro.build/en/guides/styling/#theme-switching
- CSS Custom Properties: https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom_properties

## 决策记录

### 为什么选择 2月1日-3月1日 作为时间窗口?

**决策**: 选择农历新年前后各约半个月的时间窗口

**原因**:
1. 农历新年日期不固定(在1月21日-2月20日之间浮动)
2. 2月1日-3月1日覆盖了大部分农历新年日期
3. 提前半个月开始营造节日氛围
4. 节后半个月延续节日余韵
5. 简化日期判断逻辑(易于实现和维护)

**未来优化**: 可考虑根据实际农历新年日期动态计算时间窗口

### 为什么使用 localStorage 而非其他存储方式?

**决策**: 继续使用 localStorage (与现有主题系统一致)

**原因**:
1. 与现有主题系统保持一致
2. 无需引入额外依赖
3. 浏览器原生支持,性能最优
4. 已有完善的错误处理和降级方案

### 为什么不实现完整的主题选择器下拉菜单?

**决策**: 仅在现有切换按钮基础上增加农历新年选项

**原因**:
1. 当前仅有 3 个主题(light/dark/lunar-new-year),切换按钮足够
2. 保持 UI 简洁,避免过度设计
3. 减少实现复杂度
4. 如未来主题数量增加,可再升级为下拉菜单

## 批准状态

- [ ] 提案创建
- [ ] 技术审查
- [ ] 用户体验审查
- [ ] 批准实施

---

**提案创建时间**: 2026-01-30
**提案作者**: AI Assistant
**变更 ID**: `lunar-new-year-theme-smart-default-arg-value-reasoning-thinking-process-1-analyze-the-proposal-main`
