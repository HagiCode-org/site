# 实施任务清单

## 概述

本文档列出了支持 Desktop 多渠道版本管理的具体实施任务。

**架构原则**：保持向后兼容，默认使用稳定版，渐进式添加渠道支持。

## 任务列表

### 阶段 1：准备和验证

- [ ] **1.1 验证新数据格式可用性**
  - 访问 `https://desktop.dl.hagicode.com/index.json`
  - 验证 `channels` 字段是否存在
  - 确认 `channels.stable` 和 `channels.beta` 结构
  - **预期结果**：确认新数据格式已上线或了解上线计划
  - **验证方式**：手动检查 API 响应

- [ ] **1.2 创建开发分支**
  - 创建分支 `feature/desktop-multi-channel`
  - **预期结果**：开发环境准备就绪
  - **验证方式**：`git branch`

- [ ] **1.3 验证本地开发环境**
  - 确保本地开发服务器可以正常运行
  - 验证可以访问 Desktop 下载页面
  - 测试构建命令是否正常
  - **预期结果**：开发环境准备就绪
  - **验证方式**：本地测试

### 阶段 2：更新类型定义

- [ ] **2.1 更新 apps/docs 类型定义**
  - 在 `apps/docs/src/types/desktop.ts` 中添加 `ChannelInfo` 接口
  - 更新 `DesktopIndexResponse` 接口，添加 `channels` 字段
  - 确保 TypeScript 编译通过
  - **预期结果**：类型定义包含渠道相关接口
  - **验证方式**：类型检查 + `npm run build`

- [ ] **2.2 更新 apps/website 类型定义**
  - 在 `apps/website/src/types/desktop.ts` 中添加 `ChannelInfo` 接口
  - 更新 `DesktopIndexResponse` 接口，添加 `channels` 字段
  - 确保 TypeScript 编译通过
  - **预期结果**：类型定义包含渠道相关接口
  - **验证方式**：类型检查 + `npm run build`

- [ ] **2.3 验证类型定义兼容性**
  - 确保新类型定义兼容旧数据格式
  - 测试 `channels` 字段为 `undefined` 的情况
  - **预期结果**：类型定义向后兼容
  - **验证方式**：类型检查 + 单元测试（如需要）

### 阶段 3：更新工具函数

- [ ] **3.1 更新 apps/docs 工具函数 - fetchDesktopVersions**
  - 修改 `fetchDesktopVersions()` 函数
  - 添加 `channels` 字段的验证和兼容处理
  - 确保返回数据包含 `channels`（如果存在）
  - **预期结果**：函数可以处理新旧两种数据格式
  - **验证方式**：单元测试 + 手动测试

- [ ] **3.2 更新 apps/docs 工具函数 - 添加渠道函数**
  - 添加 `getChannelLatestVersion(channel: 'stable' | 'beta')` 函数
  - 添加 `getAllChannelVersions(channel: 'stable' | 'beta')` 函数
  - 添加运行时验证，确保渠道数据存在
  - **预期结果**：可以按渠道获取版本数据
  - **验证方式**：单元测试

- [ ] **3.3 更新 apps/website 工具函数 - fetchDesktopVersions**
  - 修改 `fetchDesktopVersions()` 函数
  - 添加 `channels` 字段的验证和兼容处理
  - 确保返回数据包含 `channels`（如果存在）
  - **预期结果**：函数可以处理新旧两种数据格式
  - **验证方式**：单元测试 + 手动测试

- [ ] **3.4 更新 apps/website 工具函数 - 添加渠道函数**
  - 添加 `getChannelLatestVersion(channel: 'stable' | 'beta')` 函数
  - 添加 `getAllChannelVersions(channel: 'stable' | 'beta')` 函数
  - 添加运行时验证，确保渠道数据存在
  - **预期结果**：可以按渠道获取版本数据
  - **验证方式**：单元测试

### 阶段 4：更新 InstallButton 组件

- [ ] **4.1 更新 apps/docs InstallButton 组件**
  - 在 `InstallButtonProps` 中添加 `channel?: 'stable' | 'beta'` 属性
  - 添加默认值 `'stable'`
  - 根据 channel 属性获取对应渠道的版本
  - 为 beta 版本添加视觉标识（徽章）
  - **预期结果**：组件支持渠道属性
  - **验证方式**：本地测试 + 类型检查

- [ ] **4.2 更新 apps/website InstallButton 组件**
  - 在 `InstallButtonProps` 中添加 `channel?: 'stable' | 'beta'` 属性
  - 添加默认值 `'stable'`
  - 根据 channel 属性获取对应渠道的版本
  - 为 beta 版本添加视觉标识（徽章）
  - **预期结果**：组件支持渠道属性
  - **验证方式**：本地测试 + 类型检查

- [ ] **4.3 添加 Beta 版本视觉标识**
  - 在按钮上为 beta 版本添加"测试版"标签
  - 使用不同的颜色或样式区分 beta 版本
  - 确保在各种按钮变体下都清晰可见
  - **预期结果**：Beta 版本有明显的视觉区分
  - **验证方式**：视觉测试

### 阶段 5：更新 Desktop 下载页面

- [ ] **5.1 添加渠道切换选项卡**
  - 在 Desktop 页面顶部添加渠道选择器
  - 使用 Starlight Tabs 组件或自定义实现
  - 默认选中"稳定版"选项卡
  - **预期结果**：用户可以切换渠道
  - **验证方式**：本地测试

- [ ] **5.2 实现渠道切换逻辑**
  - 根据选择的渠道获取对应的版本数据
  - 更新页面显示的版本列表
  - 更新下载选项
  - **预期结果**：切换渠道后页面内容正确更新
  - **验证方式**：交互测试

- [ ] **5.3 添加 Beta 版本警告提示**
  - 在选择 beta 渠道时显示警告信息
  - 说明 beta 版本可能存在不稳定问题
  - 提供返回稳定版的便捷方式
  - **预期结果**：用户了解 beta 版本的风险
  - **验证方式**：视觉测试

- [ ] **5.4 更新版本历史显示**
  - 在版本列表中为每个版本添加渠道标识
  - Beta 版本使用不同的徽章或颜色
  - 确保版本历史与当前选择的渠道一致
  - **预期结果**：版本历史清晰显示渠道信息
  - **验证方式**：视觉测试

### 阶段 6：更新版本监控脚本

- [ ] **6.1 更新 version-monitor.js 以支持 channels**
  - 检查 API 响应中的 `channels` 字段
  - 从 `channels.stable.latest` 获取稳定版版本
  - 从 `channels.beta.latest` 获取测试版版本
  - **预期结果**：脚本可以处理新数据格式
  - **验证方式**：使用测试数据验证

- [ ] **6.2 验证版本监控兼容性**
  - 测试脚本在旧数据格式下的行为
  - 确保降级到 `versions` 数组处理
  - 验证不会破坏现有的版本检测逻辑
  - **预期结果**：脚本兼容新旧两种数据格式
  - **验证方式**：单元测试

- [ ] **6.3 更新版本比较逻辑（如需要）**
  - 确保可以正确比较 beta 版本
  - 确保可以正确比较 stable 版本
  - 验证 beta 到 stable 的升级检测
  - **预期结果**：版本比较逻辑正确
  - **验证方式**：单元测试

### 阶段 7：样式和 UX 优化

- [ ] **7.1 设计渠道选择器样式**
  - 设计稳定版和测试版的视觉区分
  - 确保在不同屏幕尺寸下都可用
  - 添加适当的悬停和激活状态
  - **预期结果**：渠道选择器美观易用
  - **验证方式**：视觉测试

- [ ] **7.2 添加 Beta 版本徽章样式**
  - 设计"测试版"徽章的样式
  - 确保在各种背景下都清晰可见
  - 添加适当的动画或过渡效果
  - **预期结果**：Beta 版本徽章清晰美观
  - **验证方式**：视觉测试

- [ ] **7.3 响应式设计优化**
  - 确保渠道选择器在移动设备上可用
  - 确保下载按钮在小屏幕上正常显示
  - 测试各种屏幕尺寸下的布局
  - **预期结果**：各尺寸下显示正常
  - **验证方式**：响应式设计模式测试

### 阶段 8：测试和验证

- [ ] **8.1 本地功能测试**
  - 测试渠道切换功能
  - 测试版本显示正确性
  - 测试下载链接正确性
  - 测试 beta 版本警告显示
  - **预期结果**：所有功能正常工作
  - **验证方式**：手动测试

- [ ] **8.2 向后兼容性测试**
  - 模拟旧数据格式（无 `channels` 字段）
  - 验证所有组件正常工作
  - 验证默认行为（使用稳定版）
  - **预期结果**：旧数据格式下一切正常
  - **验证方式**：使用 mock 数据测试

- [ ] **8.3 跨浏览器测试**
  - 在 Chrome/Edge 上测试
  - 在 Firefox 上测试
  - 在 Safari 上测试（如可用）
  - **预期结果**：所有主流浏览器功能一致
  - **验证方式**：逐一测试各浏览器

- [ ] **8.4 构建测试**
  - 运行 `npm run build` 确保 docs 站点构建成功
  - 运行 `npm run build` 确保 website 站点构建成功
  - 检查构建输出是否有警告或错误
  - **预期结果**：构建成功，无警告
  - **验证方式**：构建命令

- [ ] **8.5 类型检查测试**
  - 运行 TypeScript 类型检查
  - 确保没有类型错误
  - **预期结果**：类型检查通过
  - **验证方式**：`tsc --noEmit`

### 阶段 9：文档和清理

- [ ] **9.1 更新组件文档**
  - 为新增的函数添加 JSDoc 注释
  - 更新 InstallButton 组件的 props 文档
  - 说明渠道参数的用途
  - **预期结果**：代码有良好的文档注释
  - **验证方式**：代码审查

- [ ] **9.2 清理未使用的代码**
  - 检查是否有未使用的导入或变量
  - 移除任何临时调试代码
  - **预期结果**：代码库整洁，无死代码
  - **验证方式**：代码审查 + lint 工具

- [ ] **9.3 更新变更日志**
  - 在项目的 CHANGELOG 中记录此变更
  - 说明新增的多渠道版本管理功能
  - **预期结果**：变更记录完整
  - **验证方式**：文档审查

### 阶段 10：部署验证

- [ ] **10.1 创建 Pull Request**
  - 提交变更到新分支
  - 创建 PR，描述变更内容
  - **预期结果**：PR 创建成功
  - **验证方式**：GitHub PR 检查

- [ ] **10.2 部署到预览环境**
  - 通过 CI/CD 部署预览版本
  - 在预览环境中验证功能
  - **预期结果**：预览环境功能正常
  - **验证方式**：预览环境测试

- [ ] **10.3 合并到主分支**
  - 代码审查通过后合并
  - 触发生产环境部署
  - **预期结果**：生产环境更新成功
  - **验证方式**：部署日志检查

- [ ] **10.4 生产环境验证**
  - 访问生产环境的 Desktop 下载页面
  - 验证渠道切换功能
  - 验证版本显示正确性
  - 验证下载链接正确性
  - **预期结果**：生产环境功能正常
  - **验证方式**：生产环境测试

- [ ] **10.5 监控版本监控脚本**
  - 观察 version-monitor 工作流运行情况
  - 验证可以正确处理新数据格式
  - 验证不会产生错误的 PR
  - **预期结果**：版本监控正常工作
  - **验证方式**：工作流日志检查

## 实施注意事项

### 开发原则

1. **向后兼容优先**：确保所有变更都兼容旧数据格式
2. **渐进式实施**：按照任务顺序逐步完成
3. **持续验证**：每完成一个任务立即进行验证
4. **保持一致**：确保两个站点的实现保持一致

### 数据验证

在实现中需要考虑的边界情况：

1. `channels` 字段不存在（旧数据格式）
2. `channels` 存在但 `stable` 或 `beta` 缺失
3. `latest` 版本号在 `versions` 数组中不存在
4. 版本号格式不正确

### 回滚计划

如果部署后发现严重问题：

1. 回滚到之前的版本
2. InstallButton 将恢复到默认行为（稳定版）
3. Desktop 页面将恢复到原始显示
4. 不影响版本监控脚本的核心功能

### 已知限制

1. **数据源依赖**：功能依赖官方 API 提供 `channels` 数据
2. **渠道固定**：当前只支持 stable 和 beta 两个渠道
3. **用户偏好**：首次访问时默认显示稳定版

### 扩展性考虑

为未来可能的扩展预留空间：

1. 支持更多渠道（dev、canary 等）
2. 记住用户的渠道偏好
3. 根据用户行为推荐渠道
4. 更精细的版本过滤选项

## 预计工时

- 阶段 1：0.5 小时
- 阶段 2：1 小时
- 阶段 3：2-3 小时
- 阶段 4：2-3 小时
- 阶段 5：3-4 小时
- 阶段 6：1-2 小时
- 阶段 7：1-2 小时
- 阶段 8：2-3 小时
- 阶段 9：0.5 小时
- 阶段 10：1 小时

**总计**：约 14-20 小时

## 成功标准检查清单

完成实施后，验证以下标准：

- [ ] 两个站点的类型定义都包含 `channels` 字段
- [ ] 两个站点的工具函数都支持渠道参数
- [ ] 两个站点的 InstallButton 组件都支持渠道属性
- [ ] Desktop 下载页面可以切换渠道
- [ ] Beta 版本有清晰的视觉标识和警告
- [ ] 旧数据格式下所有功能正常工作
- [ ] 所有组件在两种数据格式下都正常工作
- [ ] 本地构建和测试通过
- [ ] 生产环境部署成功并验证功能
