# 实施任务清单

## 概述

本文档列出了修复 Desktop 页面版本同步问题的具体实施任务。任务按逻辑顺序排列，确保逐步完成修复。

## 任务列表

### 阶段 1：准备工作

- [ ] **1.1 验证当前问题**
  - 访问 Desktop 页面，记录当前显示的版本号
  - 检查官方 `index.json` 中的最新版本号
  - 确认版本号是否存在差异
  - **预期结果**：确认 Desktop 页面版本号确实落后于官方源

- [ ] **1.2 准备开发环境**
  - 确保本地开发服务器可以正常运行 (`npm run dev`)
  - 验证可以访问 Desktop 页面 (`/desktop`)
  - 测试构建命令是否正常 (`npm run build`)
  - **预期结果**：开发环境准备就绪

### 阶段 2：创建客户端版本获取组件

- [ ] **2.1 创建共享的版本获取 Hook**
  - 创建文件 `src/hooks/useDesktopVersions.ts`
  - 实现 `useDesktopVersions()` Hook，包含：
    - 状态管理：`versions`、`loading`、`error`
    - `useEffect` 中获取版本数据的逻辑
    - 错误处理
  - **预期结果**：创建可复用的版本数据获取 Hook
  - **验证方式**：在其他组件中导入并测试 Hook

- [ ] **2.2 创建版本显示组件**
  - 创建文件 `src/components/desktop/VersionDisplay.tsx`
  - 实现组件功能：
    - 使用 `useDesktopVersions()` Hook
    - 渲染加载状态（骨架屏或加载动画）
    - 渲染错误状态（友好提示 + 降级链接）
    - 渲染版本信息（最新版本号、支持平台）
  - **预期结果**：完整的客户端版本显示组件
  - **验证方式**：在独立页面中测试组件渲染

- [ ] **2.3 创建平台下载选项组件**
  - 创建文件 `src/components/desktop/PlatformDownloads.tsx`
  - 实现组件功能：
    - 基于版本数据渲染平台下载按钮
    - 复用现有的 `DownloadOption` 组件
    - 支持平台检测和排序
  - **预期结果**：动态的平台下载选项组件
  - **验证方式**：测试各平台下载按钮是否正常工作

- [ ] **2.4 创建版本历史组件**
  - 创建文件 `src/components/desktop/VersionHistory.tsx`
  - 实现组件功能：
    - 渲染所有版本的列表
    - 标记最新版本
    - 支持展开/收起每个版本的下载详情
  - **预期结果**：完整的版本历史组件
  - **验证方式**：测试版本列表展开/收起功能

### 阶段 3：修改 Desktop 页面

- [ ] **3.1 移除服务端版本获取逻辑**
  - 在 `src/pages/desktop/index.astro` 中：
    - 移除 `fetchDesktopVersions()` 的导入和调用
    - 移除构建时的版本数据处理逻辑
    - 移除 SSR 渲染的版本信息部分
  - **预期结果**：页面不再在构建时获取版本数据
  - **验证方式**：构建后检查生成的 HTML 是否不包含版本号

- [ ] **3.2 集成客户端组件**
  - 在 Desktop 页面中：
    - 导入新创建的客户端组件
    - 使用 `client:load` 指令加载组件
    - 替换原有的版本显示区域
  - **具体修改点**：
    - Hero Section 的版本号和下载按钮区域
    - 版本历史区域
  - **预期结果**：Desktop 页面使用客户端组件渲染版本信息
  - **验证方式**：本地开发服务器测试页面渲染

- [ ] **3.3 添加加载和错误状态 UI**
  - 为客户端组件添加状态反馈：
    - 加载中：显示骨架屏或加载动画
    - 加载失败：显示错误信息和降级链接（前往官方下载页）
  - **预期结果**：用户在各种状态下都能得到清晰的反馈
  - **验证方式**：手动模拟网络错误测试错误处理

### 阶段 4：测试与验证

- [ ] **4.1 本地功能测试**
  - 测试 Desktop 页面各项功能：
    - ✅ 版本号正确显示
    - ✅ 下载按钮链接正确
    - ✅ 平台检测和排序正常
    - ✅ 版本历史展开/收起
    - ✅ 加载状态显示
    - ✅ 错误状态处理
  - **预期结果**：所有功能正常工作
  - **验证方式**：手动测试 + 浏览器开发者工具检查网络请求

- [ ] **4.2 跨浏览器测试**
  - 在以下浏览器中测试：
    - Chrome/Edge (Chromium)
    - Firefox
    - Safari (如可用)
  - **预期结果**：所有主流浏览器功能一致
  - **验证方式**：逐一测试各浏览器

- [ ] **4.3 响应式测试**
  - 测试不同屏幕尺寸：
    - 桌面 (>1024px)
    - 平板 (768px-1024px)
    - 手机 (<768px)
  - **预期结果**：各尺寸下显示正常
  - **验证方式**：浏览器响应式设计模式

- [ ] **4.4 构建测试**
  - 运行 `npm run build` 确保构建成功
  - 检查构建输出是否有警告或错误
  - 验证生成的静态页面可以正常访问
  - **预期结果**：构建成功，无警告
  - **验证方式**：构建命令 + 预览构建结果

### 阶段 5：文档与清理

- [ ] **5.1 更新组件文档**
  - 为新创建的组件添加 JSDoc 注释
  - 更新相关 TypeScript 类型定义
  - **预期结果**：代码有良好的文档注释

- [ ] **5.2 清理未使用的代码**
  - 检查 `src/utils/desktop.ts` 是否仍有其他地方使用
  - 如果 `fetchDesktopVersions()` 不再被使用，考虑保留（作为服务端使用的工具）或添加废弃标记
  - **预期结果**：代码库整洁，无死代码

- [ ] **5.3 更新变更日志**
  - 在项目的 CHANGELOG 中记录此变更
  - **预期结果**：变更记录完整

### 阶段 6：部署验证

- [ ] **6.1 创建 Pull Request**
  - 提交变更到新分支
  - 创建 PR，描述变更内容
  - **预期结果**：PR 创建成功

- [ ] **6.2 部署到预览环境**
  - 通过 CI/CD 部署预览版本
  - 在预览环境中验证功能
  - **预期结果**：预览环境功能正常

- [ ] **6.3 合并到主分支**
  - 代码审查通过后合并
  - 触发生产环境部署
  - **预期结果**：生产环境更新成功

- [ ] **6.4 生产环境验证**
  - 访问生产环境的 Desktop 页面
  - 验证版本信息正确显示
  - **预期结果**：生产环境功能正常

- [ ] **6.5 验证版本同步**
  - 等待下一次官方版本更新
  - 或手动修改测试数据验证
  - 确认 Desktop 页面版本号自动更新
  - **预期结果**：版本同步问题已解决

## 实施注意事项

### 开发原则

1. **渐进式实施**：按照任务顺序逐步完成，每个阶段完成后再进入下一阶段
2. **持续验证**：每完成一个任务立即进行验证，确保没有引入新问题
3. **保持兼容**：确保修改不影响其他页面和功能

### 回滚计划

如果部署后发现严重问题：
1. 回滚到之前的版本
2. Desktop 页面将恢复到构建时获取版本的方式
3. 不影响其他页面功能

### 已知限制

1. **首次加载延迟**：用户首次访问时会看到短暂的加载状态
2. **离线不可用**：如果没有网络连接，无法获取版本信息（但可以通过降级链接解决）

## 预计工时

- 阶段 1：0.5 小时
- 阶段 2：2-3 小时
- 阶段 3：1-2 小时
- 阶段 4：1-2 小时
- 阶段 5：0.5 小时
- 阶段 6：1 小时

**总计**：约 6-9 小时
